<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¼ä¸šå¾®ä¿¡ç™»å½•Demo</title>
  <style>
    body {
      font-family: 'Microsoft YaHei', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
      padding: 40px;
      max-width: 500px;
      width: 90%;
      text-align: center;
    }

    .logo {
      width: 80px;
      height: 80px;
      background: #00D5AA;
      border-radius: 50%;
      margin: 0 auto 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      color: white;
      font-weight: bold;
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 16px;
    }

    .btn {
      background: linear-gradient(135deg, #00D5AA 0%, #00B894 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 10px;
      min-width: 200px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 213, 170, 0.3);
    }

    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .user-info {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
      text-align: left;
      display: none;
    }

    .user-info h3 {
      margin-top: 0;
      color: #333;
    }

    .user-info p {
      margin: 8px 0;
      color: #666;
    }

    .loading {
      display: none;
      margin: 20px 0;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #00D5AA;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .error {
      background: #ffebee;
      color: #c62828;
      border: 1px solid #ffcdd2;
      border-radius: 6px;
      padding: 12px;
      margin: 15px 0;
      display: none;
    }

    .success {
      background: #e8f5e8;
      color: #2e7d32;
      border: 1px solid #c8e6c9;
      border-radius: 6px;
      padding: 12px;
      margin: 15px 0;
      display: none;
    }

    .code-info {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
      border-radius: 6px;
      padding: 12px;
      margin: 15px 0;
      display: none;
    }
  </style>
  <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
  <script>
    // VConsole will be exported to `window.VConsole` by default.
    var vConsole = new window.VConsole();
  </script>
</head>

<body>
  <div class="container">
    <div class="logo">ä¼</div>
    <h1>ä¼ä¸šå¾®ä¿¡ç™»å½•</h1>
    <p class="subtitle">ä½¿ç”¨ä¼ä¸šå¾®ä¿¡è´¦å·å¿«é€Ÿç™»å½•</p>

    <button id="loginBtn" class="btn">ä¼ä¸šå¾®ä¿¡ç™»å½•</button>
    <button id="getUserInfoBtn" class="btn" disabled>è·å–ç”¨æˆ·ä¿¡æ¯</button>

    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p>æ­£åœ¨å¤„ç†ä¸­...</p>
    </div>

    <div class="error" id="error"></div>
    <div class="success" id="success"></div>
    <div class="code-info" id="codeInfo"></div>

    <div class="user-info" id="userInfo">
      <h3>ç”¨æˆ·ä¿¡æ¯</h3>
      <div id="userDetails"></div>
    </div>
  </div>

  <script>
    // ä¼ä¸šå¾®ä¿¡é…ç½®ä¿¡æ¯
    const CONFIG = {
      CORP_ID: 'YOUR_CORP_ID',
      CORP_SECRET: 'YOUR_CORP_SECRET',
      REDIRECT_URI: encodeURIComponent(window.location.origin + window.location.pathname),
      SCOPE: 'snsapi_privateinfo', // æˆ–è€…ä½¿ç”¨ snsapi_privateinfo è·å–æ•æ„Ÿä¿¡æ¯
      STATE: 'demo_state_' + Date.now(),
      AGENT_ID: '1000005'
    };

    // DOM å…ƒç´ 
    const loginBtn = document.getElementById('loginBtn');
    const getUserInfoBtn = document.getElementById('getUserInfoBtn');
    const loading = document.getElementById('loading');
    const error = document.getElementById('error');
    const success = document.getElementById('success');
    const codeInfo = document.getElementById('codeInfo');
    const userInfo = document.getElementById('userInfo');
    const userDetails = document.getElementById('userDetails');

    // æ˜¾ç¤ºæ¶ˆæ¯å‡½æ•°
    function showMessage(type, message) {
      // éšè—æ‰€æœ‰æ¶ˆæ¯
      error.style.display = 'none';
      success.style.display = 'none';
      codeInfo.style.display = 'none';

      const element = document.getElementById(type);
      if (element) {
        element.textContent = message;
        element.style.display = 'block';
      }
    }

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    function showLoading(show) {
      loading.style.display = show ? 'block' : 'none';
    }

    // ä¼ä¸šå¾®ä¿¡ç™»å½•
    function startWechatLogin() {
      const authUrl = `https://open.weixin.qq.com/connect/oauth2/authorize?appid=${CONFIG.CORP_ID}&redirect_uri=${CONFIG.REDIRECT_URI}&response_type=code&scope=${CONFIG.SCOPE}&state=${CONFIG.STATE}&agentid=${CONFIG.AGENT_ID}#wechat_redirect`;

      console.log("_______________ğŸš€ â˜˜ï¸â˜˜ï¸â˜˜ï¸ index.html â˜˜ï¸â˜˜ï¸â˜˜ï¸ startWechatLogin â˜˜ï¸â˜˜ï¸â˜˜ï¸ authUrl:", authUrl)


      showMessage('success', 'æ­£åœ¨è·³è½¬åˆ°ä¼ä¸šå¾®ä¿¡æˆæƒé¡µé¢...');

      // å»¶è¿Ÿè·³è½¬ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æç¤ºä¿¡æ¯
      setTimeout(() => {
        window.location.href = authUrl;
      }, 1500);
    }

    // è·å–URLå‚æ•°
    function getUrlParameter(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    // è·å–è®¿é—®ä»¤ç‰Œ
    async function getAccessToken() {
      try {
        showLoading(true);

        // æ³¨æ„ï¼šåœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè¿™ä¸ªè¯·æ±‚åº”è¯¥åœ¨åç«¯æœåŠ¡å™¨è¿›è¡Œ
        // è¿™é‡Œä»…ç”¨äºæ¼”ç¤ºï¼Œå®é™…ä½¿ç”¨æ—¶éœ€è¦é€šè¿‡åç«¯ä»£ç†
        const response = await fetch(`https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid=${CONFIG.CORP_ID}&corpsecret=${CONFIG.CORP_SECRET}`, {
          method: 'GET'
        });

        if (!response.ok) {
          throw new Error('è·å–è®¿é—®ä»¤ç‰Œå¤±è´¥');
        }

        const data = await response.json();

        if (data.errcode && data.errcode !== 0) {
          throw new Error(`è·å–è®¿é—®ä»¤ç‰Œå¤±è´¥: ${data.errmsg}`);
        }

        return data.access_token;

      } catch (err) {
        showMessage('error', 'è·å–è®¿é—®ä»¤ç‰Œå¤±è´¥: ' + err.message + '\\n\\næ³¨æ„ï¼šç”±äºè·¨åŸŸé™åˆ¶ï¼Œå®é™…é¡¹ç›®ä¸­éœ€è¦é€šè¿‡åç«¯ä»£ç†è¯·æ±‚ä¼ä¸šå¾®ä¿¡API');
        throw err;
      } finally {
        showLoading(false);
      }
    }

    // è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
    async function getUserBasicInfo(code) {
      try {
        const accessToken = await getAccessToken();

        showLoading(true);

        const response = await fetch(`https://qyapi.weixin.qq.com/cgi-bin/auth/getuserinfo?access_token=${accessToken}&code=${code}`, {
          method: 'GET'
        });

        if (!response.ok) {
          throw new Error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥');
        }

        const data = await response.json();

        if (data.errcode && data.errcode !== 0) {
          throw new Error(`è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ${data.errmsg}`);
        }

        return data;

      } catch (err) {
        showMessage('error', 'è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ' + err.message + '\\n\\næ³¨æ„ï¼šç”±äºè·¨åŸŸé™åˆ¶ï¼Œå®é™…é¡¹ç›®ä¸­éœ€è¦é€šè¿‡åç«¯ä»£ç†è¯·æ±‚ä¼ä¸šå¾®ä¿¡API');
        throw err;
      } finally {
        showLoading(false);
      }
    }

    // è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯
    async function getUserDetail(accessToken, userId) {
      try {
        showLoading(true);

        const response = await fetch(`https://qyapi.weixin.qq.com/cgi-bin/user/get?access_token=${accessToken}&userid=${userId}`, {
          method: 'GET'
        });

        if (!response.ok) {
          throw new Error('è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯å¤±è´¥');
        }

        const data = await response.json();

        if (data.errcode && data.errcode !== 0) {
          throw new Error(`è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯å¤±è´¥: ${data.errmsg}`);
        }

        return data;

      } catch (err) {
        showMessage('error', 'è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯å¤±è´¥: ' + err.message);
        throw err;
      } finally {
        showLoading(false);
      }
    }

    // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
    function displayUserInfo(userBasicInfo, userDetailInfo = null) {
      let html = '';

      // åŸºæœ¬ä¿¡æ¯
      if (userBasicInfo.userid) {
        html += `<p><strong>ç”¨æˆ·ID:</strong> ${userBasicInfo.userid}</p>`;
      }
      if (userBasicInfo.openid) {
        html += `<p><strong>OpenID:</strong> ${userBasicInfo.openid}</p>`;
      }
      if (userBasicInfo.external_userid) {
        html += `<p><strong>å¤–éƒ¨è”ç³»äººID:</strong> ${userBasicInfo.external_userid}</p>`;
      }

      // è¯¦ç»†ä¿¡æ¯
      if (userDetailInfo) {
        if (userDetailInfo.name) {
          html += `<p><strong>å§“å:</strong> ${userDetailInfo.name}</p>`;
        }
        if (userDetailInfo.department && userDetailInfo.department.length > 0) {
          html += `<p><strong>éƒ¨é—¨ID:</strong> ${userDetailInfo.department.join(', ')}</p>`;
        }
        if (userDetailInfo.position) {
          html += `<p><strong>èŒä½:</strong> ${userDetailInfo.position}</p>`;
        }
        if (userDetailInfo.mobile) {
          html += `<p><strong>æ‰‹æœºå·:</strong> ${userDetailInfo.mobile}</p>`;
        }
        if (userDetailInfo.email) {
          html += `<p><strong>é‚®ç®±:</strong> ${userDetailInfo.email}</p>`;
        }
        if (userDetailInfo.avatar) {
          html += `<p><strong>å¤´åƒ:</strong> <img src="${userDetailInfo.avatar}" width="50" height="50" style="border-radius: 50%; vertical-align: middle;"></p>`;
        }
      }

      userDetails.innerHTML = html;
      userInfo.style.display = 'block';
    }

    // å¤„ç†ä¼ä¸šå¾®ä¿¡å›è°ƒ
    async function handleWechatCallback() {
      const code = getUrlParameter('code');

      const state = getUrlParameter('state');

      console.log("_______________ğŸš€ â˜˜ï¸â˜˜ï¸â˜˜ï¸ index.html â˜˜ï¸â˜˜ï¸â˜˜ï¸ handleWechatCallback â˜˜ï¸â˜˜ï¸â˜˜ï¸ code:", code)


      if (code) {
        showMessage('codeInfo', `è·å–åˆ°æˆæƒç : ${code}`);

        if (state && !state.startsWith('demo_state_')) {
          showMessage('error', 'çŠ¶æ€å‚æ•°éªŒè¯å¤±è´¥ï¼Œå¯èƒ½å­˜åœ¨å®‰å…¨é£é™©');
          return;
        }

        getUserInfoBtn.disabled = false;

        // è‡ªåŠ¨è·å–ç”¨æˆ·ä¿¡æ¯
        try {
          const userBasicInfo = await getUserBasicInfo(code);

          if (userBasicInfo.userid) {
            // å¦‚æœæœ‰useridï¼Œå°è¯•è·å–è¯¦ç»†ä¿¡æ¯
            try {
              const accessToken = await getAccessToken();
              const userDetailInfo = await getUserDetail(accessToken, userBasicInfo.userid);
              displayUserInfo(userBasicInfo, userDetailInfo);
              showMessage('success', 'ç”¨æˆ·ä¿¡æ¯è·å–æˆåŠŸï¼');
            } catch (err) {
              // è·å–è¯¦ç»†ä¿¡æ¯å¤±è´¥ï¼Œåªæ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯
              displayUserInfo(userBasicInfo);
              showMessage('success', 'ç”¨æˆ·åŸºæœ¬ä¿¡æ¯è·å–æˆåŠŸï¼è¯¦ç»†ä¿¡æ¯è·å–å¤±è´¥ã€‚');
            }
          } else {
            displayUserInfo(userBasicInfo);
            showMessage('success', 'ç”¨æˆ·ä¿¡æ¯è·å–æˆåŠŸï¼');
          }

        } catch (err) {
          showMessage('error', 'è‡ªåŠ¨è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œè¯·ç‚¹å‡»"è·å–ç”¨æˆ·ä¿¡æ¯"æŒ‰é’®æ‰‹åŠ¨è·å–');
        }
      }
    }

    // æ‰‹åŠ¨è·å–ç”¨æˆ·ä¿¡æ¯
    async function manualGetUserInfo() {
      const code = getUrlParameter('code');

      if (!code) {
        showMessage('error', 'æœªæ‰¾åˆ°æˆæƒç ï¼Œè¯·å…ˆè¿›è¡Œä¼ä¸šå¾®ä¿¡ç™»å½•');
        return;
      }

      try {
        const userBasicInfo = await getUserBasicInfo(code);

        if (userBasicInfo.userid) {
          try {
            const accessToken = await getAccessToken();
            const userDetailInfo = await getUserDetail(accessToken, userBasicInfo.userid);
            displayUserInfo(userBasicInfo, userDetailInfo);
            showMessage('success', 'ç”¨æˆ·ä¿¡æ¯è·å–æˆåŠŸï¼');
          } catch (err) {
            displayUserInfo(userBasicInfo);
            showMessage('success', 'ç”¨æˆ·åŸºæœ¬ä¿¡æ¯è·å–æˆåŠŸï¼è¯¦ç»†ä¿¡æ¯è·å–å¤±è´¥ã€‚');
          }
        } else {
          displayUserInfo(userBasicInfo);
          showMessage('success', 'ç”¨æˆ·ä¿¡æ¯è·å–æˆåŠŸï¼');
        }

      } catch (err) {
        console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', err);
      }
    }

    // äº‹ä»¶ç›‘å¬
    loginBtn.addEventListener('click', startWechatLogin);
    // getUserInfoBtn.addEventListener('click', manualGetUserInfo);

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦æœ‰å›è°ƒå‚æ•°
    document.addEventListener('DOMContentLoaded', function () {
      handleWechatCallback();
    });
  </script>
</body>

</html>